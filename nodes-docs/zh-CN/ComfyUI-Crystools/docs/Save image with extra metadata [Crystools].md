
# Documentation
- Class name: Save image with extra metadata [Crystools]
- Category: crystools 🪛/Image
- Output node: True
- Repo Ref: https://github.com/crystian/ComfyUI-Crystools

这个节点旨在保存图像的同时附加额外的元数据，可以包括工作流程细节和用户提供的自定义元数据。它扩展了标准图像保存过程的功能，允许直接在图像文件中包含额外信息，从而增强了每个保存图像的可追溯性和上下文信息。

# Input types
## Required
- image
    - 要保存的图像。这个参数至关重要，因为它决定了将要存储并随后用于进一步处理或参考的内容。
    - Comfy dtype: IMAGE
    - Python dtype: PIL.Image.Image
- filename_prefix
    - 图像保存时使用的文件名前缀。这有助于组织和轻松识别图像，特别是在处理多个图像或批次时。
    - Comfy dtype: STRING
    - Python dtype: str
- with_workflow
    - 一个标志，指示是否应在图像的元数据中包含工作流程详细信息。这对于跟踪处理历史或生成图像所涉及的步骤非常有用。
    - Comfy dtype: BOOLEAN
    - Python dtype: bool
## Optional
- metadata_extra
    - 以JSON格式提供的额外元数据，将与图像一起包含。这提供了在图像元数据中嵌入各种类型信息的灵活性。
    - Comfy dtype: STRING
    - Python dtype: str

# Output types
- Metadata RAW
    - 图像保存过程的结果，包括保存图像的路径和任何相关的元数据。
    - Comfy dtype: METADATA_RAW
    - Python dtype: dict


## Usage tips
- Infra type: `CPU`
- Common nodes: unknown


## Source code
```python
class CImageSaveWithExtraMetadata(SaveImage):
    def __init__(self):
        super().__init__()
        self.data_cached = None
        self.data_cached_text = None

    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                # if it is required, in next node does not receive any value even the cache!
                "image": ("IMAGE",),
                "filename_prefix": ("STRING", {"default": "ComfyUI"}),
                "with_workflow": BOOLEAN,
            },
            "optional": {
                "metadata_extra": ("STRING", {"multiline": True, "default": json.dumps({
                  "Title": "Image generated by Crystian",
                  "Description": "More info: https:\/\/www.instagram.com\/crystian.ia", # "\/" is for escape / on json
                  "Author": "crystian.ia",
                  "Software": "ComfyUI",
                  "Category": "StableDiffusion",
                  "Rating": 5,
                  "UserComment": "",
                  "Keywords": [
                    ""
                  ],
                  "Copyrights": "",
                }, indent=CONFIG["indent"]).replace("\\/", "/"),
                }),
            },
            "hidden": {
                "prompt": "PROMPT",
                "extra_pnginfo": "EXTRA_PNGINFO",
            },
        }

    CATEGORY = CATEGORY.MAIN.value + CATEGORY.IMAGE.value
    RETURN_TYPES = ("METADATA_RAW",)
    RETURN_NAMES = ("Metadata RAW",)
    OUTPUT_NODE = True

    FUNCTION = "execute"

    def execute(self, image=None, filename_prefix="ComfyUI", with_workflow=True, metadata_extra=None, prompt=None, extra_pnginfo=None):
        data = {
            "result": [''],
            "ui": {
                "text": [''],
                "images": [],
            }
        }
        if image is not None:
            if with_workflow is True:
                extra_pnginfo_new = extra_pnginfo.copy()
                prompt = prompt.copy()
            else:
                extra_pnginfo_new = None
                prompt = None

            if metadata_extra is not None and metadata_extra != 'undefined':
                try:
                    metadata_extra = json.loads(f"{{{metadata_extra}}}")
                except Exception as e:
                    logger.error(f"Error parsing metadata_extra (it will send as string), error: {e}")
                    metadata_extra = {"extra": str(metadata_extra)}

                if isinstance(metadata_extra, dict):
                    for k, v in metadata_extra.items():
                        if extra_pnginfo_new is None:
                            extra_pnginfo_new = {}

                        extra_pnginfo_new[k] = v

            saved = super().save_images(image, filename_prefix, prompt, extra_pnginfo_new)

            image = saved["ui"]["images"][0]
            image_path = Path(self.output_dir).joinpath(image["subfolder"], image["filename"])
            img, promptFromImage, metadata = buildMetadata(image_path)

            images = [image]
            result = metadata

            data["result"] = [result]
            data["ui"]["images"] = images

        else:
            logger.debug("Source: Empty on CImageSaveWithExtraMetadata")

        return data

```
