
# Documentation
- Class name: Save image with extra metadata [Crystools]
- Category: crystools ğŸª›/Image
- Output node: True
- Repo Ref: https://github.com/crystian/ComfyUI-Crystools

è¿™ä¸ªèŠ‚ç‚¹æ—¨åœ¨ä¿å­˜å›¾åƒçš„åŒæ—¶é™„åŠ é¢å¤–çš„å…ƒæ•°æ®ï¼Œå¯ä»¥åŒ…æ‹¬å·¥ä½œæµç¨‹ç»†èŠ‚å’Œç”¨æˆ·æä¾›çš„è‡ªå®šä¹‰å…ƒæ•°æ®ã€‚å®ƒæ‰©å±•äº†æ ‡å‡†å›¾åƒä¿å­˜è¿‡ç¨‹çš„åŠŸèƒ½ï¼Œå…è®¸ç›´æ¥åœ¨å›¾åƒæ–‡ä»¶ä¸­åŒ…å«é¢å¤–ä¿¡æ¯ï¼Œä»è€Œå¢å¼ºäº†æ¯ä¸ªä¿å­˜å›¾åƒçš„å¯è¿½æº¯æ€§å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

# Input types
## Required
- image
    - è¦ä¿å­˜çš„å›¾åƒã€‚è¿™ä¸ªå‚æ•°è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒå†³å®šäº†å°†è¦å­˜å‚¨å¹¶éšåç”¨äºè¿›ä¸€æ­¥å¤„ç†æˆ–å‚è€ƒçš„å†…å®¹ã€‚
    - Comfy dtype: IMAGE
    - Python dtype: PIL.Image.Image
- filename_prefix
    - å›¾åƒä¿å­˜æ—¶ä½¿ç”¨çš„æ–‡ä»¶åå‰ç¼€ã€‚è¿™æœ‰åŠ©äºç»„ç»‡å’Œè½»æ¾è¯†åˆ«å›¾åƒï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤šä¸ªå›¾åƒæˆ–æ‰¹æ¬¡æ—¶ã€‚
    - Comfy dtype: STRING
    - Python dtype: str
- with_workflow
    - ä¸€ä¸ªæ ‡å¿—ï¼ŒæŒ‡ç¤ºæ˜¯å¦åº”åœ¨å›¾åƒçš„å…ƒæ•°æ®ä¸­åŒ…å«å·¥ä½œæµç¨‹è¯¦ç»†ä¿¡æ¯ã€‚è¿™å¯¹äºè·Ÿè¸ªå¤„ç†å†å²æˆ–ç”Ÿæˆå›¾åƒæ‰€æ¶‰åŠçš„æ­¥éª¤éå¸¸æœ‰ç”¨ã€‚
    - Comfy dtype: BOOLEAN
    - Python dtype: bool
## Optional
- metadata_extra
    - ä»¥JSONæ ¼å¼æä¾›çš„é¢å¤–å…ƒæ•°æ®ï¼Œå°†ä¸å›¾åƒä¸€èµ·åŒ…å«ã€‚è¿™æä¾›äº†åœ¨å›¾åƒå…ƒæ•°æ®ä¸­åµŒå…¥å„ç§ç±»å‹ä¿¡æ¯çš„çµæ´»æ€§ã€‚
    - Comfy dtype: STRING
    - Python dtype: str

# Output types
- Metadata RAW
    - å›¾åƒä¿å­˜è¿‡ç¨‹çš„ç»“æœï¼ŒåŒ…æ‹¬ä¿å­˜å›¾åƒçš„è·¯å¾„å’Œä»»ä½•ç›¸å…³çš„å…ƒæ•°æ®ã€‚
    - Comfy dtype: METADATA_RAW
    - Python dtype: dict


## Usage tips
- Infra type: `CPU`
- Common nodes: unknown


## Source code
```python
class CImageSaveWithExtraMetadata(SaveImage):
    def __init__(self):
        super().__init__()
        self.data_cached = None
        self.data_cached_text = None

    @classmethod
    def INPUT_TYPES(cls):
        return {
            "required": {
                # if it is required, in next node does not receive any value even the cache!
                "image": ("IMAGE",),
                "filename_prefix": ("STRING", {"default": "ComfyUI"}),
                "with_workflow": BOOLEAN,
            },
            "optional": {
                "metadata_extra": ("STRING", {"multiline": True, "default": json.dumps({
                  "Title": "Image generated by Crystian",
                  "Description": "More info: https:\/\/www.instagram.com\/crystian.ia", # "\/" is for escape / on json
                  "Author": "crystian.ia",
                  "Software": "ComfyUI",
                  "Category": "StableDiffusion",
                  "Rating": 5,
                  "UserComment": "",
                  "Keywords": [
                    ""
                  ],
                  "Copyrights": "",
                }, indent=CONFIG["indent"]).replace("\\/", "/"),
                }),
            },
            "hidden": {
                "prompt": "PROMPT",
                "extra_pnginfo": "EXTRA_PNGINFO",
            },
        }

    CATEGORY = CATEGORY.MAIN.value + CATEGORY.IMAGE.value
    RETURN_TYPES = ("METADATA_RAW",)
    RETURN_NAMES = ("Metadata RAW",)
    OUTPUT_NODE = True

    FUNCTION = "execute"

    def execute(self, image=None, filename_prefix="ComfyUI", with_workflow=True, metadata_extra=None, prompt=None, extra_pnginfo=None):
        data = {
            "result": [''],
            "ui": {
                "text": [''],
                "images": [],
            }
        }
        if image is not None:
            if with_workflow is True:
                extra_pnginfo_new = extra_pnginfo.copy()
                prompt = prompt.copy()
            else:
                extra_pnginfo_new = None
                prompt = None

            if metadata_extra is not None and metadata_extra != 'undefined':
                try:
                    metadata_extra = json.loads(f"{{{metadata_extra}}}")
                except Exception as e:
                    logger.error(f"Error parsing metadata_extra (it will send as string), error: {e}")
                    metadata_extra = {"extra": str(metadata_extra)}

                if isinstance(metadata_extra, dict):
                    for k, v in metadata_extra.items():
                        if extra_pnginfo_new is None:
                            extra_pnginfo_new = {}

                        extra_pnginfo_new[k] = v

            saved = super().save_images(image, filename_prefix, prompt, extra_pnginfo_new)

            image = saved["ui"]["images"][0]
            image_path = Path(self.output_dir).joinpath(image["subfolder"], image["filename"])
            img, promptFromImage, metadata = buildMetadata(image_path)

            images = [image]
            result = metadata

            data["result"] = [result]
            data["ui"]["images"] = images

        else:
            logger.debug("Source: Empty on CImageSaveWithExtraMetadata")

        return data

```
